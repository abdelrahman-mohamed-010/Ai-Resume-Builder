//Experiment eligbility and conduction based on user profile
// User Profile
// {
// }
// exprObj:{
//   var interval = setInterval(function () {
window.Profile=window.Profile||{},window.Profile.Init=function(e,t,i,r,n){var o={PremiumStatus:"Not Started",VisitedStages:[],Country:r,Role:i,UserId:e,LayerId:t,Device:n}
"guest"!=i.toLowerCase()?window.Profile.UpdateProfile(o):localStorage.setItem("VisitedStagesInfo",JSON.stringify(o))},window.Profile.ConductExperiment=function(e,t){var i=0,r=setDefaultValues(e),n=JSON.parse(localStorage.getItem("VisitedStagesInfo"))
if(!n)return-1
var o=n.VisitedStages.filter(function(e){return e.userStageId==r.StageID}),a=!(!r.UseRole||"Guest"==r.UseRole)
if(r.conductforguestusers&&a)return i
if(!e.ignoreStageCheck&&!window.Profile.CheckStageEligibility(r.StageID))return i
var s=!1
if(s=r.ExcludedCountry?-1==r.ExcludedCountry.indexOf(n.Country):r.Country.indexOf(n.Country)>-1||r.Country.toString().toUpperCase().includes("ALL"),!(r.Device.toString().toUpperCase().includes(n.Device.toUpperCase())&&s&&r.PremiumStatus.toString().toUpperCase().includes(n.PremiumStatus.toUpperCase())))return i
if(o&&o.length>0){var u=n.VisitedStages.indexOf(o[0]),l={userStageId:r.StageID,userStageDateTime:new Date}
n.VisitedStages[u]=l,localStorage.setItem("VisitedStagesInfo",JSON.stringify(n))}if(!r.IsBackend)return void 0!==window.experiment&&(i=window.experiment.conductUserExperiment(n.UserId,n.LayerId,r.ExprId).variant||0,t&&"function"==typeof t&&t(i)),i
conductBackendExperiment(n.UserId,r.ExprId,r.culture,r.logTraits,r.includeIterableIntegration,r.skipGoverning,t,!0)},window.Profile.UpdateUserPremiumStatus=function(e){var t=JSON.parse(localStorage.getItem("VisitedStagesInfo"))
t.PremiumStatus=e,localStorage.setItem("VisitedStagesInfo",JSON.stringify(t))},window.Profile.UpdateStage=function(e){var t=JSON.parse(localStorage.getItem("VisitedStagesInfo")),i=t.VisitedStages.filter(function(t){return t.userStageId==e}),r={userStageId:e,userStageDateTime:new Date}
if(i.length>0){var n=t.VisitedStages.indexOf(i[0])
t.VisitedStages[n]=r}else t.VisitedStages.push(r)
localStorage.setItem("VisitedStagesInfo",JSON.stringify(t))},window.Profile.UpdateLoginStatus=function(e){var t=JSON.parse(localStorage.getItem("VisitedStagesInfo"))
t&&(t.Role=e?"User":"Guest",localStorage.setItem("VisitedStagesInfo",JSON.stringify(t)))},window.Profile.UpdateProfile=function(e){if(!e&&localStorage.getItem("VisitedStagesInfo")&&(e=JSON.parse(localStorage.getItem("VisitedStagesInfo"))),e){var t=window.location.origin+"/api/v1/user/experimentprofile"
callAjaxExpProfile(t,"GET",!1,!0,function(t){if(t){var i=JSON.parse(t)
e.VisitedStages=i.UserStageLogs,e.PremiumStatus=i.PaymentStatus}localStorage.setItem("VisitedStagesInfo",JSON.stringify(e))},!1)}},window.Profile.CheckStageEligibility=function(e){var t=!0,i=JSON.parse(localStorage.getItem("VisitedStagesInfo")),r=i.VisitedStages.filter(function(t){return t.userStageId==e})
if(r&&r.length>0&&r[0].userStageDateTime){var n=new Date
Math.round((n-new Date(r[0].userStageDateTime))/864e5)<14&&(t=!1)}return t},window.Profile.CheckStgEligibilityAndReturnProfile=function(e){return{eligibility:window.Profile.CheckStageEligibility(e),UserProfile:JSON.parse(localStorage.getItem("VisitedStagesInfo"))}},conductBackendExperiment=function(e,t,i,r,n,o,a,s){var u=window.location.origin+"/eb/api/v2/users/"+e+"/experiments/"+t+"/conduct"
if(!s){var u=window.location.hostname+"/eb/api/v2"
return fetch(u+"users/"+e+"/experiments/"+t+"/conduct",{method:"POST",credentials:"include",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify({logTraits:r,conductForOldUsers:!0,includeIterableIntegration:n,culture:i,skipGoverning:o})}).then(function(e){if(e.ok)return console.log(e.json()),e.json()})}callAjaxExpProfile(u,"POST",!1,!0,a,!1,JSON.stringify({logTraits:r,conductForOldUsers:!0,includeIterableIntegration:n,culture:i,skipGoverning:o}))},setDefaultValues=function(e){var t=e
return t.hasOwnProperty("PremiumStatus")||(t.PremiumStatus=["Not Started","Expired"]),t.hasOwnProperty("IsBackend")||(t.IsBackend=!1),t.hasOwnProperty("Country")||(t.Country=["ALL"]),t.hasOwnProperty("Device")||(t.Device="Desktop"),t.hasOwnProperty("culture")||(t.culture="en-US"),t.hasOwnProperty("ignoreStageCheck")||(t.ignoreStageCheck=!1),t},callAjaxExpProfile=function(e,t,i,r,n,o,a){var s
s=new XMLHttpRequest,s.onload=function(){4==s.readyState&&200==s.status?n&&(o?n(s.responseText,o):n(s.responseText)):4==s.readyState&&500==s.status&&n&&n("")},s.open(t,e,i),r&&(s.withCredentials=!0),a?(s.setRequestHeader("Content-Type","application/json;charset=UTF-8"),s.send(a)):s.send()}
